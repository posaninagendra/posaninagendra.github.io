<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Core Data Explained &middot; Nagendra Posani
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="/assets/font-awesome-4.7.0/css/font-awesome.min.css">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
</head>


  <body class="theme-base-08">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Nagendra Posani
        </a>
      </h1>
      <p class="lead">A Computer Science Enthusiast, love to learn new technologies. <a href="mailto:nagendra@gatech.edu" target="_blank">Contact</a> me for any open source projects.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="/assets/resume.pdf">Resume</a>
    </nav>
    <a href="https://linkedin.com/in/posaninagendra" target="_blank">
    <i class="fa fa-linkedin"></i></a>
    &nbsp;
    <a href="https://github.com/posaninagendra" target="_blank">
    <i class="fa fa-github"></i></a>
    &nbsp;
    <a href="https://twitter.com/posaninagendra" target="_blank">
    <i class="fa fa-twitter"></i></a>
    &nbsp;
    <a href="https://facebook.com/posaninagendra" target="_blank">
    <i class="fa fa-facebook"></i></a>
    &nbsp;
    <a href="https://medium.com/@posaninagendra" target="_blank">
    <i class="fa fa-medium"></i> 
    </a>
    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Core Data Explained</h1>
  <span class="post-date">19 Jun 2017</span>
  <p>Core data is one of the most misunderstood frameworks in iOS. If one understands the individual components of the framework and its usage, it is one of the easy to use frameworks. Lets go through the individual components to get an overview of this framework and see its usage through swift code snippets and throw away the frustration.</p>

<p>Core data framework is a model layer and persistent technology. It helps you build the model layer that represents the state of your application and perform store and retrieve operations of data through objects persistently. It is not just a SQL Wrapper, it is much more than that, the most powerful feature of core data is its object graph management and it provides higher level of abstraction of the database.</p>

<p>The main principle behind this framework is letting the app to store its data in the form of objects directly in to the database tables. It provides APIs which implements heavy operations like save, delete and fetch optimally.</p>

<p>The Core data stack consists of four components as listed below.</p>

<ol>
  <li>Managed Object Context</li>
  <li>Persistent Store Coordinator</li>
  <li>Persistent Store</li>
  <li>SQLite Store</li>
</ol>

<p>All the components are inter linked and yet they are flexible to use. Lets go through each component.</p>

<h3 id="managed-object-context">Managed Object Context</h3>

<p>This component is the only component with which the app communicates. Consider this component as a scratch pad where you can write and read the objects and after all the changes made, you can save them to the store. Technically an application can have more than one context and each context can have any number of objects, the object knows in which context it is in and the context knows all its objects.</p>

<p>The object graph management is maintained in this component. Since it is in direct connection to the app, which creates the objects and saves them to the context and the context maintains the graph of these objects until they are saved in the store. For example, if we have an application with entities like student, faculty and department and corresponding tables in the database with established relationships. When you create a student object with a relation to department, Managed Object Context understands this and maintains the relationships and in future if you update any of the relationships it updates the graph accordingly, it is the same case with fetched objects from store.</p>

<h3 id="persistent-store-coordinator">Persistent Store Coordinator</h3>

<p>As the name suggests this component coordinates the contexts and stores to which they are connected. It is like a central scrutinizer which connects the contexts and stores. Technically you can have many number of stores and contexts, so this component connects a particular context to a store. It ties the object management part and persistent storage part of this framework.</p>

<p><img src="/assets/core-data/psc.png" alt="img1" /></p>

<p>In earlier versions of iOS, before iOS 10, to use core data we had to create the complete stack from the persistent store coordinator to a store and context. But from iOS 10 the APIs are made easy to create the Core Data stack.</p>

<h3 id="persistent-store">Persistent Store</h3>
<p>This is the part of the stack where persistency happens. The persistent store gives the abstraction of actual database and it provides wrapper methods to the requests. Behind the scenes it creates SQL statements to the requests that it receives and stores them in the file system.</p>

<p>In case if you want to customize the store to use your own database rather than using standard SQLite store, you can achieve that by subclassing the <code class="highlighter-rouge">NSIncrementalStore</code> which is an abstract class to implement your own storage.</p>

<h2 id="how-these-components-work-together">How these components work together?</h2>

<p>Before I explain how they work together, let me introduce to the nomenclature used by Apple in Core Data framework and its contextual meaning.</p>

<p>Swift is slowly getting rid of the NS prefix to its APIs but it didn’t reach to the Core Data yet so as of today we still have NS prefix in Core Data. We are already familiar with Managed Object Context, Persistent Store Coordinator and Persistent Store, they are called <code class="highlighter-rouge">NSManagedObjectContext</code>, <code class="highlighter-rouge">NSPersistentStoreCoordinator</code> and <code class="highlighter-rouge">NSPersistentStore</code> respectively. Apart from them we have few more components as we dive deep in to the framework like, Managed Object Model (<code class="highlighter-rouge">NSManagedObjectModel</code>), Entity Description (<code class="highlighter-rouge">NSEntityDescription</code>), Fetch Request (<code class="highlighter-rouge">NSFetchRequest</code>), Mapping Model (<code class="highlighter-rouge">NSMappingModel</code>), Migration Manager (<code class="highlighter-rouge">NSMigrationManager</code>) etc.</p>

<p>Managed Object Model is simply a model that has the information of all the entity schemas, a store coordinator is created using this model, letting it know that what kind of objects it would see. You can have different versions of this models, as your app grows you might want to update the tables (or entities) by adding/deleting properties or adding new entities etc, in all these cases you will be creating a new version of this model.</p>

<p>Entity Description is associated to a specific entity and is represented as the entries of the persistent store. It also ties the entity object to the context in which it is going to be written, along with that it has other information related to entity management.</p>

<p>Fetch request is the abstraction of database queries to retrieve data. You can create general fetch request of all the objects of a specific entity or be more specific and define the filters on attributes like SQLite queries by adding predicate (<code class="highlighter-rouge">NSPredicate</code>) to the request.</p>

<p>Mapping model and migration manager are handy components when you are dealing with migration of schema and data in the database. Mapping model explicitly defines the mapping from old schema to the new schema to ease the migration process. This is consumed by the migration manager which performs the actual migration.
570 × 1182
See the flow diagram give below to understand the Core Data stack.</p>
<p align="center">
<img src="/assets/core-data/cdstack.png" height="625" width="300" />
</p>
<p>To explain the work flow, lets consider an example, we are building a Winestore and it has entities like wine, winery and region. Lets create these entities in core data model file, the framework provides a UI interface to create the entities and define the relationships between them. Managed object model is a <code class="highlighter-rouge">.mom</code> file that is created by this data model that we created, can be referred as file-manager path URL by the persistent store coordinator.</p>

<p>Once we have entities created, we want the app to create few records or consume them, for this we need a context to write and read, lets go ahead and create a context. To define the context we need a store coordinator to connect with and to create the store coordinator we need managed object model because the store coordinator should know what objects it is talking with.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// First get the model URL, for that look for .mom</span>
<span class="c1">// file in the directory with the resource name as the name of your .xcdatamodel</span>

<span class="k">let</span> <span class="nv">bundle</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span>
<span class="k">let</span> <span class="nv">modelPath</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="nf">path</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span> <span class="nv">ofType</span><span class="p">:</span> <span class="s">"mom"</span><span class="p">)</span>
<span class="n">modelUrl</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">fileURLWithPath</span><span class="p">:</span> <span class="n">modelPath</span><span class="o">!</span><span class="p">)</span>

<span class="c1">// Create the model and persistent store coordinator</span>
<span class="k">let</span> <span class="nv">model</span> <span class="o">=</span> <span class="kt">NSManagedObjectModel</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">modelUrl</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">coordinator</span> <span class="o">=</span> <span class="kt">NSPersistentStoreCoordinator</span><span class="p">(</span><span class="nv">managedObjectModel</span><span class="p">:</span> <span class="n">model</span><span class="o">!</span><span class="p">)</span>

<span class="c1">// Create context and link it to the store coordinator</span>
<span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">NSManagedObjectContext</span><span class="p">(</span><span class="nv">concurrencyType</span><span class="p">:</span> <span class="o">.</span><span class="n">mainQueueConcurrencyType</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">persistentStoreCoordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
</code></pre>
</div>

<p>Wondering why we haven’t created the persistent store explicitly? Well, it is done silently by Persistent Store Coordinator, by default it creates <code class="highlighter-rouge">NSSQLiteStore</code> but in case if you want to create your own store in place of the default behavior you can do that as given below.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">NSPersistentStoreCoordinator</span><span class="o">.</span><span class="nf">registerStoreClass</span><span class="p">(</span><span class="kt">CustomStoreClass</span><span class="o">.</span><span class="k">self</span><span class="p">,</span>
 <span class="nv">forStoreType</span><span class="p">:</span> <span class="kt">CustomStoreType</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="k">try</span> <span class="n">coordinator</span><span class="o">.</span><span class="nf">addPersistentStore</span><span class="p">(</span><span class="nv">ofType</span><span class="p">:</span> <span class="kt">CustomStoreType</span><span class="p">,</span>
<span class="nv">configurationName</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">storeUrl</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">storeOptions</span><span class="p">)</span>
</code></pre>
</div>

<p>To define your own store you need to subclass <code class="highlighter-rouge">NSIncrementalStore</code> and implement the persistent store protocol methods and register it to the store coordinator to link to this new store instead of the default store.</p>

<p>Once we have the context, we can add objects, fetch and delete. Some of the operations are give below.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Save</span>
<span class="k">let</span> <span class="nv">wine</span> <span class="o">=</span> <span class="kt">Wine</span><span class="p">(</span><span class="nv">entity</span><span class="p">:</span> <span class="n">wineEntity</span><span class="p">,</span> <span class="nv">insertInto</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
<span class="n">wine</span><span class="o">.</span><span class="n">wineId</span> <span class="o">=</span> <span class="mi">12562</span>
<span class="n">wine</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Wine Pro"</span>
<span class="n">wine</span><span class="o">.</span><span class="n">wineDescription</span> <span class="o">=</span> <span class="s">"Wine Pro"</span>
<span class="n">wine</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">"Oldest wines"</span>
<span class="n">wine</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="mi">1970</span>

<span class="n">context</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>

<span class="c1">// Fetch</span>
<span class="k">let</span> <span class="nv">wineFetch</span> <span class="o">=</span> <span class="kt">NSFetchRequest</span><span class="o">&lt;</span><span class="kt">Wine</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">entityName</span><span class="p">:</span> <span class="s">"Wine"</span><span class="p">)</span>
<span class="n">wineFetch</span><span class="o">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="kt">NSPredicate</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="s">"wineDescription BEGINSWITH[cd] %@"</span><span class="p">,</span> <span class="s">"Wine"</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">wineCount</span> <span class="o">=</span> <span class="k">try</span> <span class="n">context</span><span class="o">.</span><span class="nf">count</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">wineFetch</span><span class="p">)</span>
</code></pre>
</div>

<p>From iOS 10+ creating core data stack made very simple, Apple added another layer of abstraction to handle the stack creation in the class <code class="highlighter-rouge">NSPersistentContrainer</code> which creates the stack and using the object of this class you can access the context through its parameters and perform the operations.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code>
<span class="kd">lazy</span> <span class="k">var</span> <span class="nv">persistentContainer</span><span class="p">:</span> <span class="kt">NSPersistentContainer</span> <span class="o">=</span> <span class="p">{</span>
      <span class="cm">/*
       The persistent container for the application. This implementation
       creates and returns a container, having loaded the store for the
       application to it. This property is optional since there are legitimate
       error conditions that could cause the creation of the store to fail.
      */</span>
      <span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="kt">NSPersistentContainer</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ToDO_App"</span><span class="p">)</span>
      <span class="n">container</span><span class="o">.</span><span class="nf">loadPersistentStores</span><span class="p">(</span><span class="nv">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">storeDescription</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
          <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as</span> <span class="kt">NSError</span><span class="p">?</span> <span class="p">{</span>
              <span class="c1">// Replace this implementation with code to handle the error appropriately.</span>
              <span class="c1">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span>

              <span class="cm">/*
               Typical reasons for an error here include:
               * The parent directory does not exist, cannot be created, or disallows writing.
               * The persistent store is not accessible, due to permissions or data protection when the device is locked.
               * The device is out of space.
               * The store could not be migrated to the current model version.
               Check the error message to determine what the actual problem was.
               */</span>
              <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unresolved error </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">userInfo</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">})</span>
      <span class="k">return</span> <span class="n">container</span>
  <span class="p">}()</span>

<span class="kd">func</span> <span class="nf">saveContext</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="n">persistentContainer</span><span class="o">.</span><span class="n">viewContext</span>
      <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">hasChanges</span> <span class="p">{</span>
          <span class="k">do</span> <span class="p">{</span>
              <span class="k">try</span> <span class="n">context</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span>
          <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
              <span class="c1">// Replace this implementation with code to handle the error appropriately.</span>
              <span class="c1">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span>
              <span class="k">let</span> <span class="nv">nserror</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as</span> <span class="kt">NSError</span>
              <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unresolved error </span><span class="se">\(</span><span class="n">nserror</span><span class="se">)</span><span class="s">, </span><span class="se">\(</span><span class="n">nserror</span><span class="o">.</span><span class="n">userInfo</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>

</code></pre>
</div>

<p>Some of the good articles that I referred while I was working on core data are given below.</p>

<ul>
  <li><a href="https://www.objc.io/issues/4-core-data/">Objc.io Core data articles</a></li>
  <li><a href="https://www.raywenderlich.com/145809/getting-started-core-data-tutorial">Raywenderlich Article on Core data</a></li>
  <li><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html">Apple documentation of Core data</a></li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/07/18/modern-authentication/">
            The AAs of security, Authentication & Authorization
            <small>18 Jul 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/06/02/wkwebview-uiwebview/">
            Web Views in iOS
            <small>02 Jun 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/05/12/review-of-cryptography/">
            A review of Cryptography
            <small>12 May 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
